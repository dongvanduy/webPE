@{
    ViewData["Title"] = "History Error";
}
@{
    Layout = "~/Areas/Allpart/Views/Shared/layout_allpart.cshtml";
}

<link rel="stylesheet" href="~/assets/css/nvidia-theme.css" />
<script src="~/lib/chart.umd.min.js"></script>

<div class="allpart-interface nvidia-section">
    <div class="section-heading text-center text-lg-start">
        <h1 class="display-6">FAIL ATE</h1>
        <p>Tra cứu lịch sử lỗi ATE với bảng dữ liệu trực quan và dễ đọc.</p>
    </div>

    <div class="row g-4 align-items-stretch">
        <div class="col-12">
            <div class="nvidia-card h-100">
                <div class="nvidia-card-header">
                    <h2>Bộ lọc tìm kiếm</h2>
                    <span class="badge-nvidia">ATE</span>
                </div>
                <div class="nvidia-card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="serialNumber" class="form-label">Serial Number</label>
                            <textarea id="serialNumber" class="form-control" rows="1" placeholder="Nhập SerialNumber..."></textarea>
                        </div>
                        <div class="col-md-2">
                            <button onclick="search()" class="btn btn-ne w-100">Tìm kiếm</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="nvidia-card">
                <div class="nvidia-card-header">
                    <h2>Kết quả tra cứu</h2>
                </div>
                <div class="nvidia-card-body">
                    <div class="table-responsive">
                        <table id="historyDataTable" class="display table table-hover table-striped datatable-table nvidia-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>SERIAL_NUMBER</th>
                                    <th>MODEL_NAME</th>
                                    <th>LINE_NAME</th>
                                    <th>SECTION_NAME</th>
                                    <th>GROUP_NAME</th>
                                    <th>STATION_NAME</th>
                                    <th>ERROR_CODE</th>
                                    <th>ERROR_DESC</th>
                                    <th>DATA6</th>
                                    <th>DATA12</th>
                                    <th>PASS_COUNT</th>
                                    <th>RETEST_COUNT</th>
                                    <th>TEST_VALUE</th>
                                    <th>IN_STATION_TIME</th>
                                    <th>RESULT</th>
                                    <th>DATA2</th>
                                    <th>TEST_MODE</th>
                                    <th>SCOF_MIN</th>
                                </tr>
                            </thead>
                            <tbody id="historyDataTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const TOOLTIP_OFFSET_X = 10;
        const TOOLTIP_OFFSET_Y = 10;
        let historyTable = null;

        function positionTooltip(evt, tooltip) {
            const pageX = evt.pageX ?? (evt.clientX + window.scrollX);
            const pageY = evt.pageY ?? (evt.clientY + window.scrollY);
            tooltip.style.left = (pageX + TOOLTIP_OFFSET_X) + 'px';
            tooltip.style.top = (pageY + TOOLTIP_OFFSET_Y) + 'px';
        }

        const pick = (obj, ...keys) => {
            for (const key of keys) {
                if (obj && obj[key] !== undefined && obj[key] !== null) {
                    return obj[key];
                }
            }
            return '';
        };

        function htmlEscape(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        async function search() {
            const sn = $("#serialNumber").val().trim().toUpperCase();
            if (!sn) {
                Swal.fire("Thông báo", "Vui lòng nhập Serial Number!", "warning");
                return;
            }

            try {
                Swal.fire({
                    title: "Đang tải dữ liệu...",
                    didOpen: () => Swal.showLoading(),
                    allowOutsideClick: false,
                    showConfirmButton: false
                });

                const response = await fetch("https://pe-vnmbd-nvidia-cns.myfiinet.com/api/CheckInOut/get-fail-ate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(sn)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API trả về lỗi: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                Swal.close();

                if (!result.success || !result.data || result.data.length === 0) {
                    Swal.fire("Không có dữ liệu!", "Không tìm thấy dữ liệu lỗi cho SN: " + sn, "info");
                    if (historyTable) {
                        historyTable.clear().draw();
                    }
                    return;
                }

                renderTable(result.data);
            } catch (err) {
                Swal.close();
                console.error(err);
                Swal.fire("Lỗi!", err.message, "error");
            }
        }

        function renderTable(data) {
            if (!historyTable) {
                historyTable = $('#historyDataTable').DataTable({
                    pageLength: 10,
                    scrollX: true,
                    responsive: false,
                    autoWidth: false,
                    columnDefs: [
                        { targets: '_all', defaultContent: '', width: '210px' }
                    ]
                });
            } else {
                historyTable.clear();
            }

            data.forEach(item => {
                historyTable.row.add([
                    createTooltipCell(pick(item, 'serial_Number', 'serialNumber')),
                    createTooltipCell(pick(item, 'model_Name', 'modelName')),
                    createTooltipCell(pick(item, 'line_Name', 'lineName')),
                    createTooltipCell(pick(item, 'section_Name', 'sectionName')),
                    createTooltipCell(pick(item, 'group_Name', 'groupName')),
                    createTooltipCell(pick(item, 'station_Name', 'stationName')),
                    createTooltipCell(pick(item, 'error_Code', 'errorCode')),
                    createTooltipCell(pick(item, 'error_Desc', 'errorDesc')),
                    createTooltipCell(pick(item, 'data6', 'dataSix', 'data_6')),
                    createTooltipCell(pick(item, 'data12', 'dataTwelve', 'data_12')),
                    createTooltipCell(pick(item, 'pass_Count', 'passCount')),
                    createTooltipCell(pick(item, 'retest_Count', 'retestCount')),
                    createTooltipCell(pick(item, 'test_Value', 'testValue')),
                    createTooltipCell(pick(item, 'in_Station_Time', 'inStationTime')),
                    createTooltipCell(pick(item, 'result')),
                    createTooltipCell(pick(item, 'data2', 'data_2')),
                    createTooltipCell(pick(item, 'test_Mode', 'testMode')),
                    createTooltipCell(pick(item, 'scof_Min', 'scofMin'))
                ]);
            });

            historyTable.draw();
            attachTooltipEvents();
        }

        function createTooltipCell(data) {
            const text = htmlEscape(data);
            return `<span class="tooltip-trigger" data-tooltip="${text}">${text}</span>`;
        }

        function attachTooltipEvents() {
            $(document)
                .off('.tooltipHover')
                .on('mouseover.tooltipHover', '.tooltip-trigger', function (e) {
                    const tooltipText = $(this).data('tooltip');
                    if (!tooltipText) return;

                    let tooltip = document.querySelector('.custom-tooltip');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'custom-tooltip';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.textContent = tooltipText;
                    tooltip.style.display = 'block';
                    positionTooltip(e, tooltip);
                })
                .on('mousemove.tooltipHover', '.tooltip-trigger', function (e) {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip && tooltip.style.display === 'block') {
                        positionTooltip(e, tooltip);
                    }
                })
                .on('mouseout.tooltipHover', '.tooltip-trigger', function () {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip) {
                        tooltip.style.display = 'none';
                    }
                });
        }
    </script>
}
