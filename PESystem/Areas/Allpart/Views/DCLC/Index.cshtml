@{
    ViewData["Title"] = "Allpart DC-LC";
}
@{
    Layout = "~/Areas/Allpart/Views/Shared/layout_allpart.cshtml";
}

<link rel="stylesheet" href="~/assets/css/nvidia-theme.css" />
<script src="~/lib/chart.umd.min.js"></script>

<div class="allpart-interface nvidia-section">
    <div class="section-heading text-center text-lg-start">
        <h1 class="display-6">Tìm kiếm thông tin linh kiện DC/LC</h1>
        <p>Tra cứu nhanh và tải xuống dữ liệu DC/LC với giao diện hiện đại mang sắc xanh NVIDIA.</p>
    </div>

    <div class="row g-4 align-items-stretch">
        <div class="col-12">
            <div class="nvidia-card h-100">
                <div class="nvidia-card-header">
                    <h2>Bộ lọc tìm kiếm</h2>
                    <span class="badge-nvidia">DC-LC</span>
                </div>
                <div class="nvidia-card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="serialNumber" class="form-label">Serial Number</label>
                            <textarea id="serialNumber" class="form-control" rows="3" placeholder="Nhập SerialNumber (mỗi dòng một giá trị)"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="refDes" class="form-label">Vị trí</label>
                            <textarea id="refDes" class="form-control" rows="3" placeholder="Nhập vị trí (mỗi dòng một giá trị)..."></textarea>
                        </div>
                        <div class="col-md-2">
                            <button onclick="search()" class="btn btn-ne w-100">Tìm kiếm</button>
                        </div>
                        <div class="col-md-2">
                            <button onclick="downloadExcel()" class="btn btn-ne w-100">Tải xuống Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="nvidia-card">
                <div class="nvidia-card-header">
                    <h2>Kết quả tra cứu</h2>
                </div>
                <div class="nvidia-card-body">
                    <div class="table-responsive">
                        <table id="dcLcTable" class="display table table-hover table-striped datatable-table nvidia-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>P_SN</th>
                                    <th>MODEL_NAME</th>
                                    <th>MÃ_LIỆU</th>
                                    <th>VENDOR_CODE</th>
                                    <th>VENDOR_NAME</th>
                                    <th>REF_DES</th>
                                    <th>DATE_CODE</th>
                                    <th>LOT_CODE</th>
                                    <th>PROCESS_FLAG</th>
                                    <th>STATION</th>
                                    <th>GROUP_NAME</th>
                                    <th>WORK_TIME</th>
                                    <th>WO</th>
                                </tr>
                            </thead>
                            <tbody id="dcLcTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const TOOLTIP_OFFSET_X = 10;
        const TOOLTIP_OFFSET_Y = 10;
        let dcLcTable;

        function positionTooltip(evt, tooltip) {
            const pageX = evt.pageX ?? (evt.clientX + window.scrollX);
            const pageY = evt.pageY ?? (evt.clientY + window.scrollY);
            tooltip.style.left = (pageX + TOOLTIP_OFFSET_X) + 'px';
            tooltip.style.top = (pageY + TOOLTIP_OFFSET_Y) + 'px';
        }

        function htmlEscape(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function createTooltipCell(data) {
            const text = htmlEscape(data);
            return `<span class="tooltip-trigger" data-tooltip="${text}">${text}</span>`;
        }

        function attachTooltipEvents() {
            $(document)
                .off('.tooltipHover')
                .on('mouseover.tooltipHover', '.tooltip-trigger', function (e) {
                    const tooltipText = $(this).data('tooltip');
                    if (!tooltipText) return;

                    let tooltip = document.querySelector('.custom-tooltip');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'custom-tooltip';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.textContent = tooltipText;
                    tooltip.style.display = 'block';
                    positionTooltip(e, tooltip);
                })
                .on('mousemove.tooltipHover', '.tooltip-trigger', function (e) {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip && tooltip.style.display === 'block') {
                        positionTooltip(e, tooltip);
                    }
                })
                .on('mouseout.tooltipHover', '.tooltip-trigger', function () {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip) {
                        tooltip.style.display = 'none';
                    }
                });
        }

        $(document).ready(function () {
            dcLcTable = $('#dcLcTable').DataTable({
                pageLength: 10,
                scrollX: true,
                responsive: false,
                autoWidth: false,
                columnDefs: [
                    { targets: '_all', width: '210px' }
                ]
            });

            attachTooltipEvents();
        });

        async function search() {
            const serialNumberText = document.getElementById('serialNumber').value.trim();
            const refDesText = document.getElementById('refDes').value.trim();

            const serialNumbers = serialNumberText.split('\n').filter(s => s);
            const refDesValues = refDesText.split('\n').filter(r => r);

            if (serialNumbers.length === 0 || refDesValues.length === 0) {
                alert('Vui lòng nhập đầy đủ Serial Number và Reference Designator (ít nhất một giá trị mỗi ô)!');
                return;
            }

            const var2 = refDesValues.join(';');

            dcLcTable.clear();

            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                        <div class="spinner"></div>
                        <div>Đang tải dữ liệu, vui lòng chờ...</div>
                    `;
            loadingOverlay.style.display = 'flex';
            document.body.appendChild(loadingOverlay);

            try {
                const batchSize = 50;
                let allResults = [];

                for (let i = 0; i < serialNumbers.length; i += batchSize) {
                    const batch = serialNumbers.slice(i, i + batchSize);
                    const var1 = batch.join(';');

                    const dcLcResponse = await fetch('https://vnmbd-apapi-cns.myfiinet.com/all_api/api/public/table', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type: 'GET_DC_LC',
                            item: 'BY-RE-SN',
                            var_1: var1,
                            var_2: var2
                        })
                    });

                    if (!dcLcResponse.ok) {
                        const errorText = await dcLcResponse.text();
                        throw new Error(`Lỗi khi gọi API GET_DC_LC: ${dcLcResponse.status} - ${errorText}`);
                    }

                    const dcLcData = await dcLcResponse.json();

                    if (dcLcData && dcLcData.result && dcLcData.result.length > 0) {
                        allResults = allResults.concat(dcLcData.result);
                    }
                }

                if (allResults.length === 0) {
                    alert('Không tìm thấy dữ liệu hợp lệ từ API!');
                    document.body.removeChild(loadingOverlay);
                    return;
                }

                allResults.forEach(item => {
                    dcLcTable.row.add([
                        createTooltipCell(item.p_sn),
                        createTooltipCell(item.p_no),
                        createTooltipCell(item.kp_no),
                        createTooltipCell(item.mfr_kp_no),
                        createTooltipCell(item.mfr_name),
                        createTooltipCell(item.ref_des),
                        createTooltipCell(item.date_code),
                        createTooltipCell(item.lot_code),
                        createTooltipCell(item.process_flag),
                        createTooltipCell(item.station),
                        createTooltipCell(item.group_name),
                        createTooltipCell(item.work_time),
                        createTooltipCell(item.wo)
                    ]).draw();
                });

                attachTooltipEvents();

            } catch (error) {
                alert(`Đã xảy ra lỗi: ${error.message}`);
            } finally {
                document.body.removeChild(loadingOverlay);
            }
        }

        function downloadExcel() {
            const allData = dcLcTable.rows().data().toArray();

            if (allData.length === 0) {
                alert('Không có dữ liệu để tải xuống.');
                return;
            }

            const exportData = allData.map(row => ({
                P_SN: $(row[0]).text(),
                MODEL_NAME: $(row[1]).text(),
                MÃ_LIỆU: $(row[2]).text(),
                VENDOR_CODE: $(row[3]).text(),
                VENDOR_NAME: $(row[4]).text(),
                REF_DES: $(row[5]).text(),
                DATE_CODE: $(row[6]).text(),
                LOT_CODE: $(row[7]).text(),
                PROCESS_FLAG: $(row[8]).text(),
                STATION: $(row[9]).text(),
                GROUP_NAME: $(row[10]).text(),
                WORK_TIME: $(row[11]).text(),
                WO: $(row[12]).text()
            }));

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'DCLC');
            XLSX.writeFile(workbook, `DCLC_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
}
