@{
    ViewData["Title"] = "YR follow DC-LC";
}
@{
    Layout = "~/Areas/Allpart/Views/Shared/layout_allpart.cshtml";
}

<link rel="stylesheet" href="~/assets/css/nvidia-theme.css" />
<script src="~/lib/chart.umd.min.js"></script>

<div class="allpart-interface nvidia-section">
    <div class="section-heading text-center text-lg-start">
        <h1 class="display-6">YR follow DC/LC</h1>
        <p>Theo dõi dữ liệu YR theo DC/LC với bộ lọc linh hoạt và bảng thống kê rõ ràng.</p>
    </div>

    <div class="row g-4 align-items-stretch">
        <div class="col-12">
            <div class="nvidia-card h-100">
                <div class="nvidia-card-header">
                    <h2>Bộ lọc tìm kiếm</h2>
                    <span class="badge-nvidia">YR - DC/LC</span>
                </div>
                <div class="nvidia-card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Khoảng thời gian</label>
                            <div class="d-flex flex-column flex-md-row gap-2">
                                <input type="datetime-local" id="startDate" class="form-control" />
                                <input type="datetime-local" id="endDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="model" class="form-label">Model Name</label>
                            <input id="model" name="model" class="form-control" placeholder="Model Name" />
                        </div>
                        <div class="col-md-2">
                            <label for="PN" class="form-label">Mã Liệu</label>
                            <input id="PN" name="PN" class="form-control" placeholder="Mã Liệu" />
                        </div>
                        <div class="col-md-2">
                            <label for="location" class="form-label">Vị trí</label>
                            <input id="location" name="location" class="form-control" placeholder="Vị trí" />
                        </div>
                        <div class="col-md-2">
                            <label for="station" class="form-label">Trạm test</label>
                            <input id="station" name="station" class="form-control" placeholder="Trạm test" />
                        </div>
                        <div class="col-md-2">
                            <label for="error" class="form-label">Mã lỗi</label>
                            <input id="error" name="error" class="form-control" placeholder="Mã lỗi" />
                        </div>
                        <div class="col-md-2">
                            <button onclick="search()" class="btn btn-ne w-100">Tìm kiếm</button>
                        </div>
                        <div class="col-md-2">
                            <button onclick="downloadExcel()" class="btn btn-ne w-100">Load data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="nvidia-card">
                <div class="nvidia-card-header">
                    <h2>Kết quả tổng hợp</h2>
                </div>
                <div class="nvidia-card-body">
                    <div class="table-responsive">
                        <table id="yrdcLcTable" class="display table table-hover table-striped datatable-table nvidia-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>MODEL_NAME</th>
                                    <th>MÃ_LIỆU</th>
                                    <th>DATE_CODE</th>
                                    <th>LOT_CODE</th>
                                    <th>VENDOR_NAME</th>
                                    <th>INPUT_QTY</th>
                                    <th>FAIL_QTY</th>
                                    <th>PASS_QTY</th>
                                    <th>DFR</th>
                                </tr>
                            </thead>
                            <tbody id="yrdcLcTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const TOOLTIP_OFFSET_X = 10;
        const TOOLTIP_OFFSET_Y = 10;
        let yrdcLcTable;
        let snDataCache = [];

        function positionTooltip(evt, tooltip) {
            const pageX = evt.pageX ?? (evt.clientX + window.scrollX);
            const pageY = evt.pageY ?? (evt.clientY + window.scrollY);
            tooltip.style.left = (pageX + TOOLTIP_OFFSET_X) + 'px';
            tooltip.style.top = (pageY + TOOLTIP_OFFSET_Y) + 'px';
        }

        function htmlEscape(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function createTooltipCell(data) {
            const text = htmlEscape(data);
            return `<span class="tooltip-trigger" data-tooltip="${text}">${text}</span>`;
        }

        function attachTooltipEvents() {
            $(document)
                .off('.tooltipHover')
                .on('mouseover.tooltipHover', '.tooltip-trigger', function (e) {
                    const tooltipText = $(this).data('tooltip');
                    if (!tooltipText) return;

                    let tooltip = document.querySelector('.custom-tooltip');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'custom-tooltip';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.textContent = tooltipText;
                    tooltip.style.display = 'block';
                    positionTooltip(e, tooltip);
                })
                .on('mousemove.tooltipHover', '.tooltip-trigger', function (e) {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip && tooltip.style.display === 'block') {
                        positionTooltip(e, tooltip);
                    }
                })
                .on('mouseout.tooltipHover', '.tooltip-trigger', function () {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip) {
                        tooltip.style.display = 'none';
                    }
                });
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        $(document).ready(function () {
            yrdcLcTable = $('#yrdcLcTable').DataTable({
                pageLength: 10,
                scrollX: true,
                responsive: false,
                autoWidth: false,
                columnDefs: [
                    { targets: '_all', width: '210px' }
                ]
            });

            attachTooltipEvents();
        });

        async function search() {
            const model = document.getElementById('model').value.trim();
            const PN = document.getElementById('PN').value.trim();
            const location = document.getElementById('location').value.trim();
            const station = document.getElementById('station').value.trim();
            const error = document.getElementById('error').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!model || !PN || !station || !error || !location || !startDate || !endDate) {
                alert('Vui lòng nhập đầy đủ tất cả các trường!');
                return;
            }

            const formattedStartDate = formatDateTime(startDate);
            const formattedEndDate = formatDateTime(endDate);

            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="spinner"></div>
                <div>Đang tải dữ liệu, vui lòng chờ...</div>
            `;
            loadingOverlay.style.display = 'flex';
            document.body.appendChild(loadingOverlay);

            try {
                yrdcLcTable.clear();

                const totalResponse = await fetch('https://vnmbd-apapi-cns.myfiinet.com/all_api/api/public/table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'GET_DC_LC',
                        item: 'BY-FAIL-TOTAL',
                        var_1: model,
                        var_2: PN,
                        var_3: formattedStartDate,
                        var_4: formattedEndDate,
                        var_5: station,
                        var_6: error,
                        var_7: location
                    })
                });

                if (!totalResponse.ok) {
                    throw new Error(`Lỗi khi gọi API BY-FAIL-TOTAL: ${await totalResponse.text()}`);
                }

                const totalData = await totalResponse.json();
                if (!totalData.result || totalData.result.length === 0) {
                    alert('Không tìm thấy dữ liệu từ API BY-FAIL-TOTAL!');
                    document.body.removeChild(loadingOverlay);
                    return;
                }

                totalData.result.forEach(item => {
                    yrdcLcTable.row.add([
                        createTooltipCell(item.model_name),
                        createTooltipCell(item.kp_no),
                        createTooltipCell(item.date_code),
                        createTooltipCell(item.lot_code),
                        createTooltipCell(item.mfr_name),
                        createTooltipCell(item.input_qty),
                        createTooltipCell(item.fail_qty),
                        createTooltipCell(item.pass_qty),
                        createTooltipCell(item.dfr)
                    ]);
                });
                yrdcLcTable.draw();

                const snResponse = await fetch('https://vnmbd-apapi-cns.myfiinet.com/all_api/api/public/table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'GET_DC_LC',
                        item: 'BY-FAIL-SN',
                        var_1: model,
                        var_2: PN,
                        var_3: formattedStartDate,
                        var_4: formattedEndDate,
                        var_5: station,
                        var_6: error,
                        var_7: location
                    })
                });

                if (!snResponse.ok) {
                    throw new Error(`Lỗi khi gọi API BY-FAIL-SN: ${await snResponse.text()}`);
                }

                const snData = await snResponse.json();
                snDataCache = snData.result || [];

                attachTooltipEvents();
            } catch (error) {
                alert(`Đã xảy ra lỗi: ${error.message}`);
            } finally {
                document.body.removeChild(loadingOverlay);
            }
        }

        function downloadExcel() {
            if (!snDataCache.length) {
                alert('Không có dữ liệu SN để tải.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(snDataCache);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'YR-DC-LC');
            XLSX.writeFile(workbook, `YR_DC_LC_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
}
