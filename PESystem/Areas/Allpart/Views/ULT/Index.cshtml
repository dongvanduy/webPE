@* File: Areas/Allpart/Views/ScanATestB/Index.cshtml *@
@{
    ViewData["Title"] = "Check ULT data";
    Layout = "~/Areas/Allpart/Views/Shared/layout_allpart.cshtml";
}

<link rel="stylesheet" href="~/assets/css/nvidia-theme.css" />
<script src="~/lib/chart.umd.min.js"></script>

<div class="allpart-interface nvidia-section">
    <div class="section-heading text-center text-lg-start">
        <h1 class="display-6">Tìm kiếm thông tin ULT</h1>
        <p>Kiểm tra dữ liệu ULT với bảng thống kê hiện đại và dễ theo dõi.</p>
    </div>

    <div class="row g-4 align-items-stretch">
        <div class="col-12">
            <div class="nvidia-card h-100">
                <div class="nvidia-card-header">
                    <h2>Bộ lọc tìm kiếm</h2>
                    <span class="badge-nvidia">ULT</span>
                </div>
                <div class="nvidia-card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="serialNumber" class="form-label">Serial Number / ULT</label>
                            <textarea id="serialNumber" class="form-control" rows="3" placeholder="Nhập SerialNumber/ULT"></textarea>
                        </div>
                        <div class="col-md-2">
                            <label for="type-options" class="form-label">Chọn kiểu tra cứu</label>
                            <select id="type-options" class="form-select">
                                <option selected disabled>SELECT TYPE</option>
                                <option value="SN">Tra cứu theo SN</option>
                                <option value="ULT">Tra cứu theo ULT</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="view-mode" class="form-label">Chế độ hiển thị</label>
                            <select id="view-mode" class="form-select" title="Chọn dữ liệu cho bảng và xuất Excel">
                                <option value="all" selected>Tất cả dữ liệu</option>
                                <option value="latest">Kết quả mới nhất (mỗi SN)</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex flex-column gap-2">
                            <button onclick="search()" class="btn btn-ne w-100">Tìm kiếm</button>
                            <button onclick="downloadExcel()" class="btn btn-ne w-100">Tải xuống Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="nvidia-card">
                <div class="nvidia-card-header">
                    <h2>Kết quả tra cứu</h2>
                </div>
                <div class="nvidia-card-body">
                    <div class="table-responsive">
                        <table id="ULTDataTable" class="display table table-hover table-striped datatable-table nvidia-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>SERIAL_NUMBER</th>
                                    <th>MODEL_NAME</th>
                                    <th>GROUP_NAME</th>
                                    <th>TEST_TIME</th>
                                    <th>ULT</th>
                                    <th>STATION_NAME</th>
                                    <th>TEST_ON</th>
                                    <th>TEST_OFF</th>
                                    <th>TEST_RESULT</th>
                                </tr>
                            </thead>
                            <tbody id="ULTDataTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let rawResults = [];
        let tableData = [];
        let dataTable;

        function createTooltipCell(data) {
            const v = data ?? '';
            return `<span class="tooltip-trigger" data-tooltip="${escapeHtml(String(v))}">${escapeHtml(String(v))}</span>`;
        }
        const TOOLTIP_OFFSET_X = 10;
        const TOOLTIP_OFFSET_Y = 10;

        function positionTooltip(evt, tooltip) {
            const pageX = evt.pageX ?? (evt.clientX + window.scrollX);
            const pageY = evt.pageY ?? (evt.clientY + window.scrollY);
            tooltip.style.left = (pageX + TOOLTIP_OFFSET_X) + 'px';
            tooltip.style.top = (pageY + TOOLTIP_OFFSET_Y) + 'px';
        }

        function attachTooltipEvents() {
            document.querySelectorAll('.tooltip-trigger').forEach(el => {
                if (el.dataset.tooltipBound) return;
                el.addEventListener('mouseover', (e) => {
                    let tip = document.querySelector('.custom-tooltip');
                    if (!tip) {
                        tip = document.createElement('div');
                        tip.className = 'custom-tooltip';
                        document.body.appendChild(tip);
                    }
                    tip.textContent = el.getAttribute('data-tooltip') || '';
                    tip.style.display = 'block';
                    positionTooltip(e, tip);
                });
                el.addEventListener('mousemove', (e) => {
                    const tip = document.querySelector('.custom-tooltip');
                    if (tip) {
                        positionTooltip(e, tip);
                    }
                });
                el.addEventListener('mouseout', () => {
                    const tip = document.querySelector('.custom-tooltip');
                    if (tip) tip.style.display = 'none';
                });
                el.dataset.tooltipBound = '1';
            });
        }

        function escapeHtml(s) {
            return s
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return '';
            const d = new Date(dateTime);
            if (isNaN(d.getTime())) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}/${m}/${day}`;
        }
        function toTime(row) {
            const t = Date.parse(row?.TEST_TIME);
            return !Number.isNaN(t) ? t : -Infinity;
        }

        function getLatestPerSN(items) {
            const bySn = new Map();
            for (const it of items) {
                const sn = (it?.SERIAL_NUMBER ?? '').trim();
                const key = sn || `__NO_SN__${Math.random().toString(36).slice(2)}`;
                const cur = bySn.get(key);
                if (!cur) {
                    bySn.set(key, it);
                } else {
                    if (toTime(it) > toTime(cur)) bySn.set(key, it);
                }
            }
            return Array.from(bySn.values());
        }

        function renderTable(rows) {
            if (!dataTable) return;
            dataTable.clear();
            rows.forEach(r => {
                dataTable.row.add([
                    createTooltipCell(r.SERIAL_NUMBER ?? ''),
                    createTooltipCell(r.MODEL_NAME ?? ''),
                    createTooltipCell(r.GROUP_NAME ?? ''),
                    createTooltipCell(r.TEST_TIME ?? ''),
                    createTooltipCell(r.ULT ?? ''),
                    createTooltipCell(r.STATION_NAME ?? ''),
                    createTooltipCell(r.TEST_ON ?? ''),
                    createTooltipCell(r.TEST_OFF ?? ''),
                    createTooltipCell(r.TEST_RESULT ?? '')
                ]);
            });
            dataTable.draw();
            attachTooltipEvents();
        }
        function applyViewAndRender() {
            const mode = document.getElementById('view-mode').value;
            if (mode === 'latest') {
                tableData = getLatestPerSN(rawResults);
            } else {
                tableData = [...rawResults];
            }
            renderTable(tableData);
        }

        $(document).ready(function () {
            dataTable = $('#ULTDataTable').DataTable({
                pageLength: 10,
                scrollX: true,
                responsive: false,
                autoWidth: false,
                columnDefs: [
                    { targets: '_all', width: '210px' }
                ]
            });
            attachTooltipEvents();
            document.getElementById('view-mode').addEventListener('change', applyViewAndRender);
        });

        async function search() {
            const inputRaw = document.getElementById('serialNumber').value.trim();
            const typeOption = document.getElementById('type-options').value;

            if (!inputRaw) { alert('Vui lòng nhập ít nhất một giá trị.'); return; }
            if (!typeOption || typeOption === 'SELECT TYPE') { alert('Vui lòng chọn kiểu tra cứu.'); return; }

            const inputList = inputRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            if (inputList.length === 0) { alert('Danh sách trống.'); return; }

            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `<div class="spinner"></div><div>Đang tải dữ liệu, vui lòng chờ...</div>`;
            overlay.style.display = 'flex';
            document.body.appendChild(overlay);

            try {
                let allResults = [];
                const batchSize = 100;
                for (let i = 0; i < inputList.length; i += batchSize) {
                const batch = inputList.slice(i, i + batchSize);
                const payload = {
                    type: typeOption,
                    data: batch
                };

                    const response = await fetch('https://pe-vnmbd-nvidia-cns.myfiinet.com/api/SFC/search-ult-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.status === 404) {
                    continue;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi gọi API: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                if (Array.isArray(result) && result.length > 0) {
                    allResults = allResults.concat(result);
                }
            }

            rawResults = allResults.map(item => ({
                    SERIAL_NUMBER: item.SERIAL_NUMBER ?? '',
                    MODEL_NAME: item.MODEL_NAME ?? '',
                    GROUP_NAME: item.GROUP_NAME ?? '',
                    TEST_TIME: item.TEST_TIME ?? '',
                    ULT: item.ULT ?? '',
                    STATION_NAME: item.STATION_NAME ?? '',
                    TEST_ON: item.TEST_ON ?? '',
                    TEST_OFF: item.TEST_OFF ?? '',
                    TEST_RESULT: item.TEST_RESULT ?? ''
                }));

                applyViewAndRender();

            } catch (error) {
                alert(`Đã xảy ra lỗi: ${error.message}`);
            } finally {
                document.body.removeChild(overlay);
            }
        }

        function downloadExcel() {
            if (!tableData.length) {
                alert('Không có dữ liệu để xuất Excel.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(tableData.map(row => ({
                SERIAL_NUMBER: row.SERIAL_NUMBER,
                MODEL_NAME: row.MODEL_NAME,
                GROUP_NAME: row.GROUP_NAME,
                TEST_TIME: row.TEST_TIME,
                ULT: row.ULT,
                STATION_NAME: row.STATION_NAME,
                TEST_ON: row.TEST_ON,
                TEST_OFF: row.TEST_OFF,
                TEST_RESULT: row.TEST_RESULT
            })));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ULT');
            XLSX.writeFile(workbook, `ULT_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
}
