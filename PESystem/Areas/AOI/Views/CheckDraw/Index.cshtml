@{
    ViewData["Title"] = "Hệ thống AOI Web";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    #canvas-container {
        position: relative;
        display: inline-block;
        border: 2px solid #666;
        background-color: #333;
        overflow: hidden;
    }

    canvas {
        cursor: crosshair;
        display: block;
    }

    .zone-item {
        background-color: #fff3cd;
        border: 1px solid #ffecb5;
        margin-bottom: 5px;
        padding: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> Công cụ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Chọn Bản Vẽ:</label>
                        <input type="file" id="inpFile" class="form-control" accept="image/*,.pdf" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Vẽ Vùng Zoom (Zone):</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning active" id="btnDrawMode">
                                <i class="fas fa-pencil-alt"></i> Chế độ Vẽ (Kéo thả)
                            </button>
                        </div>
                        <hr />
                        <h6>Danh sách Zone:</h6>
                        <div id="zoneList" style="max-height: 200px; overflow-y: auto;">
                            <small class="text-muted">Chưa có vùng nào.</small>
                        </div>
                        <button class="btn btn-sm btn-danger w-100 mt-2" onclick="clearZones()">Xóa Tất Cả</button>
                    </div>

                    <hr />
                    <button id="btnProcess" class="btn btn-success w-100 fw-bold py-2" onclick="submitData()" disabled>
                        <i class="fas fa-microchip"></i> Xử lý AI & Xuất PPTX
                    </button>

                    <div id="loader" class="text-center mt-3 d-none">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-primary">Đang phân tích AI...</p>
                    </div>

                    <div id="resultBox" class="mt-3 d-none">
                        <a id="btnDownload" href="#" class="btn btn-info w-100 fw-bold text-white">
                            <i class="fas fa-download"></i> Tải Báo Cáo PPTX
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9 bg-secondary p-2 text-center" style="height: 85vh; overflow: auto;">
            <div id="canvas-container">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {+++++9
    <script>
        // Sử dụng Vanilla JS để tránh lỗi "$ is not defined"
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let img = new Image();
        let zones = []; // {x, y, w, h}
        let isDrawing = false;
        let startX, startY;

        // 1. Load Ảnh
        document.getElementById('inpFile').addEventListener('change', function (e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        draw();
                        document.getElementById('btnProcess').disabled = false;
                    }
                    img.src = evt.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // 2. Hàm vẽ
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Vẽ ảnh nền
            if (img.src) {
                ctx.drawImage(img, 0, 0);
            }

            // Vẽ các zone
            zones.forEach((z, i) => {
                ctx.strokeStyle = '#ff6600';
                ctx.lineWidth = 5;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect(z.x, z.y, z.w, z.h);

                ctx.fillStyle = '#ff6600';
                ctx.font = 'bold 40px Arial';
                ctx.fillText(`ZONE ${i + 1}`, z.x, z.y - 10);
            });
            ctx.setLineDash([]);
        }

        // 3. Sự kiện chuột (Mouse Events)
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousedown', e => {
            isDrawing = true;
            const p = getMousePos(e);
            startX = p.x;
            startY = p.y;
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const p = getMousePos(e);
            draw();

            // Vẽ khung đang kéo (preview)
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.strokeRect(startX, startY, p.x - startX, p.y - startY);
        });

        canvas.addEventListener('mouseup', e => {
            if (!isDrawing) return;
            isDrawing = false;
            const p = getMousePos(e);

            // Tính toán toạ độ chuẩn (xử lý kéo ngược)
            let x = Math.min(startX, p.x);
            let y = Math.min(startY, p.y);
            let w = Math.abs(p.x - startX);
            let h = Math.abs(p.y - startY);

            // Chỉ lưu nếu vùng vẽ đủ lớn (>30px)
            if (w > 30 && h > 30) {
                zones.push({ x, y, w, h });
                updateZoneUI();
            }
            draw();
        });

        // 4. Cập nhật UI danh sách Zone
        function updateZoneUI() {
            const list = document.getElementById('zoneList');
            list.innerHTML = '';

            if (zones.length === 0) {
                list.innerHTML = '<small class="text-muted">Chưa có vùng nào.</small>';
                return;
            }

            zones.forEach((z, i) => {
                const item = document.createElement('div');
                item.className = 'zone-item';
                item.innerHTML = `<span><strong>Zone ${i + 1}</strong></span>
                                  <button class="btn btn-sm btn-danger py-0" onclick="removeZone(${i})">X</button>`;
                list.appendChild(item);
            });
        }

        // Đưa hàm ra global scope để gọi được từ onclick HTML
        window.removeZone = function(index) {
            zones.splice(index, 1);
            updateZoneUI();
            draw();
        }

        window.clearZones = function() {
            zones = [];
            updateZoneUI();
            draw();
        }

        // 5. Gửi dữ liệu về Server
        window.submitData = function() {
            if (zones.length === 0) {
                alert("Bạn chưa vẽ vùng Zoom nào!");
                return;
            }

            // Chuyển đổi định dạng cho Python: [x1, y1, x2, y2]
            const pyZones = zones.map(z => [
                Math.round(z.x),
                Math.round(z.y),
                Math.round(z.x + z.w),
                Math.round(z.y + z.h)
            ]);

            const fileInput = document.getElementById('inpFile');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('zonesData', JSON.stringify(pyZones));

            // Hiển thị loading
            const loader = document.getElementById('loader');
            const resultBox = document.getElementById('resultBox');
            const btnProcess = document.getElementById('btnProcess');

            loader.classList.remove('d-none');
            resultBox.classList.add('d-none');
            btnProcess.disabled = true;

            // Sử dụng Fetch API thay vì $.ajax để không phụ thuộc jQuery
            fetch('/AOI/CheckDraw/Analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(res => {
                loader.classList.add('d-none');
                btnProcess.disabled = false;

                if (res.success) {
                    const btnDownload = document.getElementById('btnDownload');
                    btnDownload.href = res.downloadUrl;
                    resultBox.classList.remove('d-none');
                    alert("Xử lý thành công!");
                } else {
                    console.error(res);
                    alert("Lỗi: " + res.message);
                }
            })
            .catch(err => {
                loader.classList.add('d-none');
                btnProcess.disabled = false;
                console.error(err);
                alert("Lỗi kết nối Server.");
            });
        }
    </script>
}